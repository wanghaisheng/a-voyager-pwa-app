# Voyager PWA 架构总览

本文档提供了 Voyager PWA 应用的架构设计、核心模块、数据流和技术栈说明，帮助开发者理解系统的整体结构和工作原理。

## 1. 系统架构

### 1.1 分层设计

Voyager PWA 应用采用了清晰的分层架构设计，各层职责如下：

```
┌─────────────────────────────────────────────────────────────┐
│                        表现层 (UI)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   页面组件   │  │  功能组件   │  │     共享UI组件      │  │
│  │  (Pages)    │  │ (Features)  │  │  (Shared Components)│  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                      状态管理层 (State)                      │
│  ┌─────────────────────────┐  ┌───────────────────────────┐ │
│  │      Redux Store        │  │      Context API          │ │
│  │  (全局状态与数据缓存)    │  │  (组件树内状态共享)       │ │
│  └─────────────────────────┘  └───────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│                      业务逻辑层 (Logic)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Hooks     │  │   Helpers   │  │      Slices         │  │
│  │ (业务逻辑)   │  │ (工具函数)  │  │  (状态逻辑与更新)    │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                      服务层 (Services)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  API 服务   │  │  本地存储   │  │     设备功能        │  │
│  │ (lemmy.ts)  │  │  (db.ts)    │  │  (Capacitor插件)    │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
├─────────────────────────────────────────────────────────────┤
│                      平台适配层 (Platform)                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │     Web         │  │    Android      │  │     iOS      │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

#### 表现层 (UI)

负责用户界面的渲染和交互，包括：
- **页面组件 (Pages)**: 完整的页面视图，如帖子详情页、社区页等
- **功能组件 (Features)**: 特定功能的组件，如评论列表、帖子卡片等
- **共享UI组件 (Shared Components)**: 可复用的UI元素，如按钮、卡片、表单等

#### 状态管理层 (State)

负责应用状态的管理和数据流控制，包括：
- **Redux Store**: 全局状态管理，处理跨组件数据共享和持久化
- **Context API**: 组件树内的状态共享，用于特定功能模块内的状态管理

#### 业务逻辑层 (Logic)

负责实现业务逻辑和数据处理，包括：
- **Hooks**: 封装业务逻辑的自定义钩子，如 `useCommentActions`
- **Helpers**: 通用工具函数，如日期格式化、URL处理等
- **Slices**: Redux Toolkit 的状态切片，包含状态定义和更新逻辑

#### 服务层 (Services)

负责与外部系统和设备功能的交互，包括：
- **API 服务**: 与后端 API 的通信，如 `lemmy.ts`
- **本地存储**: 本地数据库操作，如 `db.ts`
- **设备功能**: 通过 Capacitor 插件访问设备功能，如相机、通知等

#### 平台适配层 (Platform)

负责不同平台的特定代码和配置，包括：
- **Web**: Web 平台特定的代码和优化
- **Android**: Android 平台特定的代码和配置
- **iOS**: iOS 平台特定的代码和配置

### 1.2 数据流

Voyager PWA 应用采用单向数据流模式，主要数据流向如下：

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│            │    │            │    │            │    │            │
│  用户交互  │───>│  Action    │───>│  Reducer   │───>│   State    │
│            │    │  Dispatch  │    │            │    │            │
└────────────┘    └────────────┘    └────────────┘    └────────────┘
                                                            │
                                                            ▼
                                                      ┌────────────┐
                                                      │            │
                                                      │  UI 更新   │
                                                      │            │
                                                      └────────────┘
```

1. **用户交互**: 用户与 UI 组件交互（点击、输入等）
2. **Action Dispatch**: 组件触发 Action，可能包含异步操作（API 调用等）
3. **Reducer**: Reducer 处理 Action 并更新状态
4. **State**: 状态更新后通知订阅的组件
5. **UI 更新**: 组件根据新状态重新渲染

对于异步操作，数据流程如下：

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│            │    │            │    │            │    │            │
│  用户交互  │───>│  Thunk     │───>│  API 调用  │───>│  Action    │
│            │    │  Dispatch  │    │            │    │  Dispatch  │
└────────────┘    └────────────┘    └────────────┘    └────────────┘
                                                            │
                                                            ▼
                                                      ┌────────────┐
                                                      │            │
                                                      │  Reducer   │
                                                      │            │
                                                      └────────────┘
                                                            │
                                                            ▼
                                                      ┌────────────┐
                                                      │            │
                                                      │   State    │
                                                      │            │
                                                      └────────────┘
                                                            │
                                                            ▼
                                                      ┌────────────┐
                                                      │            │
                                                      │  UI 更新   │
                                                      │            │
                                                      └────────────┘
```

## 2. 核心模块

### 2.1 认证模块 (auth)

负责用户认证和会话管理：
- **登录/注册**: 用户身份验证和账户创建
- **会话管理**: 令牌存储和刷新
- **账户切换**: 多账户支持

主要文件：
- `src/features/auth/authSlice.ts`: 认证状态管理
- `src/features/auth/login/`: 登录相关组件
- `src/core/Auth.tsx`: 认证核心逻辑

### 2.2 帖子模块 (post)

负责帖子的展示、创建和交互：
- **帖子列表**: 展示帖子列表
- **帖子详情**: 展示帖子详情和评论
- **帖子创建/编辑**: 创建和编辑帖子
- **帖子交互**: 投票、收藏、分享等

主要文件：
- `src/features/post/`: 帖子相关组件和逻辑
- `src/routes/pages/PostPage.tsx`: 帖子详情页

### 2.3 评论模块 (comment)

负责评论的展示、创建和交互：
- **评论列表**: 展示评论列表
- **评论创建/编辑**: 创建和编辑评论
- **评论交互**: 投票、回复等

主要文件：
- `src/features/comment/`: 评论相关组件和逻辑
- `src/features/comment/commentSlice.ts`: 评论状态管理

### 2.4 社区模块 (community)

负责社区的浏览、订阅和管理：
- **社区列表**: 展示社区列表
- **社区详情**: 展示社区详情和帖子
- **社区订阅**: 订阅和取消订阅社区
- **社区管理**: 社区管理功能（对管理员）

主要文件：
- `src/features/community/`: 社区相关组件和逻辑
- `src/features/community/communitySlice.ts`: 社区状态管理

### 2.5 信息流模块 (feed)

负责各类内容的聚合展示：
- **首页信息流**: 首页内容展示
- **社区信息流**: 特定社区内容展示
- **用户信息流**: 特定用户内容展示
- **排序和筛选**: 内容排序和筛选功能

主要文件：
- `src/features/feed/`: 信息流相关组件和逻辑
- `src/features/feed/Feed.tsx`: 主信息流组件

### 2.6 设置模块 (settings)

负责用户偏好和应用配置：
- **主题设置**: 主题切换和自定义
- **通知设置**: 通知偏好配置
- **隐私设置**: 隐私相关配置
- **应用设置**: 应用行为配置

主要文件：
- `src/features/settings/`: 设置相关组件和逻辑

### 2.7 媒体模块 (media)

负责媒体内容的处理：
- **图片查看**: 图片查看和缩放
- **视频播放**: 视频播放控制
- **媒体上传**: 媒体上传功能

主要文件：
- `src/features/media/`: 媒体相关组件和逻辑

## 3. 技术栈

### 3.1 前端框架和库

- **React**: UI 库，用于构建用户界面
- **Redux Toolkit**: 状态管理库，简化 Redux 使用
- **Ionic Framework**: UI 组件库，提供移动端风格的组件
- **TypeScript**: 类型化的 JavaScript 超集，提供类型安全
- **Vite**: 现代前端构建工具，提供快速的开发体验

### 3.2 移动端适配

- **Capacitor**: 跨平台应用开发框架，将 Web 应用打包为原生应用
- **Capacitor Plugins**: 提供访问设备原生功能的插件

### 3.3 API 和数据处理

- **Lemmy API**: 与 Lemmy 实例交互的 API
- **IndexedDB**: 通过 `db.ts` 服务封装，用于本地数据存储

### 3.4 样式和主题

- **CSS Modules**: 组件级样式隔离
- **CSS Variables**: 用于主题切换和样式定制

### 3.5 测试和质量保证

- **Jest**: JavaScript 测试框架
- **Playwright**: 端到端测试框架
- **ESLint**: JavaScript 和 TypeScript 代码质量检查
- **Prettier**: 代码格式化工具

### 3.6 构建和部署

- **GitHub Actions**: CI/CD 自动化工作流
- **Fastlane**: 移动应用自动化部署工具

## 4. 数据存储

### 4.1 远程数据

应用主要通过 Lemmy API 与远程服务器交互，获取和修改数据：

- **帖子数据**: 从 Lemmy 实例获取帖子列表和详情
- **评论数据**: 从 Lemmy 实例获取评论列表和详情
- **社区数据**: 从 Lemmy 实例获取社区列表和详情
- **用户数据**: 从 Lemmy 实例获取用户信息和操作

### 4.2 本地数据

应用使用 IndexedDB 存储本地数据，通过 `db.ts` 服务封装：

- **用户会话**: 存储用户登录信息和令牌
- **缓存数据**: 缓存远程数据，提供离线访问
- **用户偏好**: 存储用户设置和偏好
- **草稿**: 存储未发布的帖子和评论草稿

## 5. 通信和集成

### 5.1 API 通信

应用主要与以下 API 通信：

- **Lemmy API**: 社区、帖子、评论等核心功能
- **Lemmyverse API**: 实例目录和元数据
- **RedGifs API**: GIF 媒体内容

### 5.2 设备集成

通过 Capacitor 插件与设备原生功能集成：

- **相机和图库**: 用于媒体上传
- **推送通知**: 用于通知用户新消息和活动
- **分享功能**: 用于分享内容到其他应用
- **深度链接**: 用于处理应用内链接

## 6. 性能优化

应用采用以下策略优化性能：

- **虚拟列表**: 用于高效渲染长列表
- **懒加载**: 延迟加载非关键资源
- **数据缓存**: 缓存远程数据减少网络请求
- **代码分割**: 按路由分割代码减少初始加载时间
- **PWA 特性**: 提供离线访问和快速加载

## 7. 安全考虑

应用采用以下安全措施：

- **令牌管理**: 安全存储和刷新认证令牌
- **输入验证**: 验证用户输入防止注入攻击
- **HTTPS**: 使用加密通信保护数据传输
- **内容安全策略**: 防止 XSS 和其他注入攻击

## 8. 可访问性

应用注重可访问性设计：

- **语义化 HTML**: 使用语义化标签提高屏幕阅读器兼容性
- **键盘导航**: 支持键盘导航
- **颜色对比**: 确保足够的颜色对比度
- **响应式设计**: 适应不同屏幕尺寸和方向

## 9. 国际化和本地化

应用支持多语言和本地化：

- **翻译**: 支持多语言界面
- **日期和时间格式**: 根据用户区域设置格式化
- **RTL 支持**: 支持从右到左的语言

## 10. 总结

Voyager PWA 应用采用现代前端架构和技术栈，提供跨平台的社交媒体浏览和交互体验。通过清晰的分层设计和模块化组织，应用具有良好的可维护性和可扩展性，能够支持团队协作开发和快速迭代。